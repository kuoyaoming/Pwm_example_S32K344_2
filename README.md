# S32K344 RGB LED PWM Control Project

## 專案概述
本專案基於NXP S32K344微控制器，使用eMIOS PWM模組控制Cree® PLCC6 3-in-1 SMD LED (CLP6C-FKB)，實現絲滑的RGB色彩變化效果。從最初的單色LED閃爍，逐步演進為完整的RGB色彩展示系統。

## 硬體配置
- **微控制器**: S32K344 (ARM Cortex-M7, 48MHz)
- **RGB LED**: Cree® CLP6C-FKB (6.0x5.0mm PLCC6 封裝)
- **引腳配置**:
  - PTA29 (EMIOS_1_CH_12) → 紅色通道 (PwmChannel_0)
  - PTA30 (EMIOS_1_CH_13) → 綠色通道 (PwmChannel_1)  
  - PTA31 (EMIOS_1_CH_14) → 藍色通道 (PwmChannel_2)

## 開發歷程與改進

### 階段1: 基礎LED閃爍 (v1.0)
**目標**: 將原有的每秒開關LED改為呼吸燈效果
- **原始狀態**: 簡單的LED開關控制
- **改進內容**: 
  - 實現漸亮漸暗的呼吸燈效果
  - 使用PWM控制亮度變化
  - 基本的延遲控制

### 階段2: 多LED呼吸燈 (v2.0)
**目標**: 擴展到三個LED，各自獨立的呼吸頻率
- **新增功能**:
  - 支援PwmChannel_0、PwmChannel_1、PwmChannel_2
  - 每個LED具有不同的呼吸頻率
  - 多LED同步控制
- **遇到問題**: 編譯警告 (unused variable)
- **解決方案**: 移除未使用的變數宣告

### 階段3: 硬體配置除錯 (v3.0)
**問題**: LED無法正常點亮
- **問題分析**: 
  - 多個PWM通道共用同一個eMIOS Master Bus
  - eMIOS配置衝突導致LED無法正常工作
- **解決方案**:
  - 分析`.mex`配置文件
  - 重新配置eMIOS Master Bus分配:
    - PwmChannel_0 → EMIOS_1_MasteBus1 (CH_8)
    - PwmChannel_1 → EMIOS_1_MasteBus4 (CH_23)
    - PwmChannel_2 → EMIOS_1_MasteBus3 (CH_22)

### 階段4: 配置工具問題解決 (v4.0)
**問題**: 配置工具中Master Bus選項有限
- **問題詳情**:
  - 只有EmiosMclMasterBus_0可選
  - EMIOS_PWM_IP_BUS_BCDE選項限制
- **解決過程**:
  - 分析eMIOS通道映射
  - 嘗試不同的Bus配置組合
  - 最終成功配置三個獨立的Master Bus

### 階段5: 隨機頻率呼吸燈 (v5.0)
**目標**: 實現此起彼落的動態效果
- **新增功能**:
  - 每個LED完成呼吸週期後隨機改變速度
  - 偽隨機數生成器 (Linear Congruential Generator)
  - 速度範圍：1-8倍速度因子
- **效果**: 創造出豐富多變的呼吸節奏

### 階段6: 呼吸邏輯修正 (v6.0)
**問題**: LED在最亮時直接關閉，無漸暗效果
- **問題分析**: 
  - 漸暗邏輯錯誤
  - PWM計數器類型 (MCB_UP_COUNTER) 設定不當
- **解決方案**:
  - 修正fade-out邏輯
  - 確保led_step正確遞減
  - 統一漸亮漸暗的佔空比計算

### 階段7: 程式優化 (v7.0)
**目標**: 最小化計算和記憶體使用
- **優化內容**:
  - 引入LedState_t結構整合LED狀態
  - 使用位移運算替代除法/模運算
  - 優化DelayLoop函數
  - 創建UpdateLed通用函數減少程式碼重複
  - 所有註解改為中文

### 階段8: 平滑度改善 (v8.0)
**問題**: 優化後變得生硬，漸變不夠平滑
- **解決方案**:
  - 增加步數從8步到64步 (8倍平滑度)
  - 使用正弦曲線查找表
  - 調整延遲時間和速度範圍
- **效果**: 達到極致平滑的漸變效果

### 階段9: RGB色彩系統 (v9.0)
**目標**: 展現所有顏色組合的絲滑變化
- **重大升級**:
  - 實現HSV到RGB色彩空間轉換
  - 支援360度完整色相環
  - 根據Cree LED datasheet進行色彩校準:
    - 紅色: 100% (基準)
    - 綠色: 85% (最亮，需降低)
    - 藍色: 110% (最暗，需增強)
  - 128步高精度亮度控制

### 階段10: PWM溢出問題解決 (v10.0)
**嚴重問題**: 中期亮度出現黑色閃爍
- **根本原因**: PWM週期設定錯誤
  - 錯誤設定: PWM週期 0x9000，但MAX_DUTY 0x8000
  - RGB值超過PWM週期導致計數器溢出
- **解決方案**:
  - 修正PWM週期為標準的0x8000
  - 實現三層安全保護機制
  - 移除有問題的查找表，改用實時計算
  - 確保所有RGB值在安全範圍內

### 階段11: 專注色彩展示 (v11.0 - 最終版)
**目標**: 移除呼吸效果，專注展現所有顏色組合
- **最終優化**:
  - 移除呼吸亮度變化
  - 固定亮度86% (鮮豔但不刺眼)
  - 100%飽和度展現純正色彩
  - 66Hz更新頻率 (15ms間隔)
  - 隨機速度變化增加視覺豐富度

## 技術特色

### PWM控制系統
- **標準PWM範圍**: 0x0000 (0%) ~ 0x8000 (100%)
- **解析度**: 32768步超高精度
- **頻率**: 約1.46kHz (48MHz/32768)
- **三重安全保護**: 計算層、轉換層、輸出層

### RGB色彩系統
- **色彩空間**: HSV → RGB轉換
- **色相範圍**: 完整360度色相環
- **飽和度**: 100% (純色)
- **亮度**: 固定86% (28,067/32768)

### Cree LED校準
```c
// 基於CLP6C-FKB規格的色彩校準
#define RED_SCALE_FACTOR    (100U)  // 紅色基準
#define GREEN_SCALE_FACTOR  (85U)   // 綠色降低 (最亮)
#define BLUE_SCALE_FACTOR   (110U)  // 藍色增強 (最暗)
```

### 效能優化
- **記憶體使用**: 最小化結構體設計
- **計算效率**: 位移運算、直接計算
- **更新頻率**: 66Hz平衡效能與流暢度

## 最終效果

### 視覺表現
- ✅ **絲滑變化**: 66Hz高刷新率，無階梯感
- ✅ **完整色譜**: 紅→橙→黃→綠→青→藍→紫→洋紅→紅
- ✅ **純正色彩**: 100%飽和度，86%固定亮度
- ✅ **隨機節奏**: 每輪循環速度不同
- ✅ **無閃爍**: 完美的PWM範圍控制

### 技術指標
- **色相解析度**: 360步 (1度/步)
- **PWM解析度**: 32768步
- **更新週期**: 15ms (66Hz)
- **色彩準確度**: 基於LED datasheet校準
- **系統穩定性**: 零溢出、零閃爍

## 開發工具
- **IDE**: S32 Design Studio 3.5
- **配置工具**: S32 Configuration Tool (.mex)
- **編譯器**: GCC for ARM
- **除錯器**: PNE (Pemicro Debug Interface)

## 文件結構
```
Pwm_example_S32K344_2/
├── src/main.c                    # 主程式
├── generate/                     # 自動生成的配置文件
│   ├── include/
│   └── src/
├── RTD/                          # Runtime驅動程式
├── board/                        # 板級配置
├── Project_Settings/             # 專案設定
├── Pwm_Example_DS.mex           # S32配置文件
└── README.md                    # 本文件
```

## 學習要點

### PWM控制關鍵
1. **週期設定**: 必須符合AUTOSAR標準 (0x8000)
2. **溢出保護**: 確保佔空比不超過週期
3. **eMIOS配置**: 避免Master Bus衝突

### 色彩系統設計
1. **HSV優勢**: 更直觀的色彩控制
2. **硬體校準**: 根據LED特性調整
3. **效能平衡**: 實時計算vs查找表

### 除錯技巧
1. **配置分析**: 理解.mex生成的程式碼
2. **硬體映射**: Pin → eMIOS → PWM通道對應
3. **數值範圍**: 確保所有計算在有效範圍內

## 致謝
感謝在開發過程中的問題發現和解決方案討論，特別是PWM週期配置錯誤的及時糾正，以及對最終效果的確認和改進建議。

---
**專案狀態**: ✅ 完成 - 效果評分 100分  
**最後更新**: 2024年  
**版本**: v11.0 (RGB色彩展示最終版)
